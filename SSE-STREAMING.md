# SSE æµå¼ä¼ è¾“åŠŸèƒ½æŒ‡å—

## ğŸ”„ Server-Sent Events (SSE) æµå¼ä¼ è¾“

AI è§’è‰²èŠå¤©ç³»ç»Ÿæ”¯æŒ SSE æµå¼ä¼ è¾“ï¼Œæä¾›å®æ—¶çš„æ‰“å­—æœºæ•ˆæœï¼Œå¤§å¤§æå‡ç”¨æˆ·ä½“éªŒã€‚

## åŠŸèƒ½ç‰¹ç‚¹

### âœ¨ ç”¨æˆ·ä½“éªŒæå‡
- **å®æ—¶åé¦ˆ**: ç”¨æˆ·æ— éœ€ç­‰å¾…å®Œæ•´å›å¤ï¼Œå¯ä»¥ç«‹å³çœ‹åˆ° AI å¼€å§‹"æ€è€ƒ"
- **æ‰“å­—æœºæ•ˆæœ**: æ¨¡æ‹ŸçœŸäººæ‰“å­—çš„è§†è§‰æ•ˆæœï¼Œæ›´åŠ è‡ªç„¶
- **å³æ—¶å“åº”æ„Ÿ**: é™ä½ç”¨æˆ·æ„ŸçŸ¥çš„ç­‰å¾…æ—¶é—´
- **æ›´çœŸå®çš„å¯¹è¯**: è¥é€ æ›´åŠ çœŸå®çš„èŠå¤©æ°›å›´

### ğŸ›ï¸ çµæ´»æ§åˆ¶
- **ç”¨æˆ·å¯é€‰**: ç”¨æˆ·å¯ä»¥åœ¨ç•Œé¢ä¸­å¼€å¯/å…³é—­æµå¼ä¼ è¾“
- **è§’è‰²é…ç½®**: æ¯ä¸ªè§’è‰²å¯ä»¥è®¾ç½®ä¸åŒçš„æµå¼é€Ÿåº¦
- **å…¼å®¹æ€§**: ä¿ç•™ä¼ ç»Ÿ APIï¼Œç¡®ä¿å‘åå…¼å®¹

## æŠ€æœ¯å®ç°

### åç«¯ SSE ç«¯ç‚¹
```javascript
// æµå¼èŠå¤©ç«¯ç‚¹
GET /api/chat/stream

// æŸ¥è¯¢å‚æ•°
- message: ç”¨æˆ·æ¶ˆæ¯ (URLç¼–ç )
- actorId: è§’è‰²ID
- chatHistory: èŠå¤©å†å² (JSONç¼–ç )
```

### äº‹ä»¶ç±»å‹
```javascript
// å¼€å§‹ç”Ÿæˆ
{
  "type": "start",
  "actor": { "id": "actor-id", "name": "è§’è‰²å", "avatar": "ğŸ­" },
  "timestamp": "2024-01-01T00:00:00.000Z"
}

// å†…å®¹ç‰‡æ®µ
{
  "type": "chunk", 
  "content": "æ–°å¢çš„æ–‡å­—ç‰‡æ®µ",
  "fullContent": "åˆ°ç›®å‰ä¸ºæ­¢çš„å®Œæ•´å†…å®¹"
}

// ç”Ÿæˆå®Œæˆ
{
  "type": "end",
  "message": "å®Œæ•´çš„å›å¤æ¶ˆæ¯",
  "actor": { "id": "actor-id", "name": "è§’è‰²å", "avatar": "ğŸ­" },
  "timestamp": "2024-01-01T00:00:00.000Z"
}

// é”™è¯¯å¤„ç†
{
  "type": "error",
  "error": "é”™è¯¯æè¿°",
  "details": "è¯¦ç»†é”™è¯¯ä¿¡æ¯ (ä»…å¼€å‘ç¯å¢ƒ)"
}
```

### å‰ç«¯å®ç°
```javascript
// åˆ›å»º EventSource è¿æ¥
const eventSource = new EventSource(streamUrl);

eventSource.onmessage = function(event) {
    const data = JSON.parse(event.data);
    
    switch (data.type) {
        case 'start':
            // åˆ›å»ºæ¶ˆæ¯å®¹å™¨ï¼Œæ˜¾ç¤º"æ­£åœ¨æ€è€ƒ"
            break;
        case 'chunk': 
            // æ›´æ–°æ¶ˆæ¯å†…å®¹ï¼Œæ·»åŠ æ‰“å­—å…‰æ ‡
            break;
        case 'end':
            // å®Œæˆæ¶ˆæ¯ï¼Œç§»é™¤å…‰æ ‡
            break;
        case 'error':
            // æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯
            break;
    }
};
```

## è§’è‰²é…ç½®

### æµå¼ä¼ è¾“è®¾ç½®
æ¯ä¸ªè§’è‰²é…ç½®æ–‡ä»¶æ”¯æŒä»¥ä¸‹æµå¼è®¾ç½®ï¼š

```json
{
  "responseSettings": {
    "streamingEnabled": true,
    "streamingSpeed": "medium"
  }
}
```

### é€Ÿåº¦é…ç½®
- **`fast`**: å¿«é€Ÿæ˜¾ç¤ºï¼Œé€‚åˆæ´»æ³¼è§’è‰² (å¦‚å¼€æœ—æœ‹å‹)
- **`medium`**: ä¸­ç­‰é€Ÿåº¦ï¼Œé€‚åˆå¤§å¤šæ•°è§’è‰² (å¦‚æ™ºè€…ã€ä¾¦æ¢)
- **`slow`**: æ…¢é€Ÿæ˜¾ç¤ºï¼Œé€‚åˆè¯—æ„è§’è‰² (å¦‚æµªæ¼«è¯—äºº)

## ç”¨æˆ·ç•Œé¢

### æµå¼ä¼ è¾“å¼€å…³
ç”¨æˆ·å¯ä»¥åœ¨èŠå¤©ç•Œé¢ä¸­æ§åˆ¶æµå¼ä¼ è¾“ï¼š

```html
<div class="streaming-toggle">
    <input type="checkbox" id="streamingToggle" checked>
    <label for="streamingToggle">ğŸ”„ æµå¼ä¼ è¾“ï¼ˆæ‰“å­—æœºæ•ˆæœï¼‰</label>
</div>
```

### è§†è§‰æ•ˆæœ
- **æ‰“å­—å…‰æ ‡**: é—ªçƒçš„ `|` å…‰æ ‡è·Ÿéšæ–‡å­—
- **æ€è€ƒæç¤º**: "æ­£åœ¨æ€è€ƒ..." åŠ¨ç”»
- **æ¸å…¥åŠ¨ç”»**: æ–‡å­—é€æ¸å‡ºç°çš„æ•ˆæœ

## æ€§èƒ½ä¼˜åŒ–

### è¿æ¥ç®¡ç†
- **è‡ªåŠ¨é‡è¿**: è¿æ¥æ–­å¼€æ—¶è‡ªåŠ¨é‡è¯•
- **è¶…æ—¶å¤„ç†**: 30ç§’è¶…æ—¶ä¿æŠ¤
- **èµ„æºæ¸…ç†**: åŠæ—¶å…³é—­ EventSource è¿æ¥

### å†…å­˜ç®¡ç†
- **æµå¼ç¼“å­˜**: é¿å…é‡å¤æ¸²æŸ“æ•´ä¸ªæ¶ˆæ¯
- **DOM ä¼˜åŒ–**: åªæ›´æ–°å˜åŒ–çš„éƒ¨åˆ†
- **äº‹ä»¶æ¸…ç†**: ç§»é™¤ä¸éœ€è¦çš„äº‹ä»¶ç›‘å¬å™¨

## æµè§ˆå™¨å…¼å®¹æ€§

### æ”¯æŒæƒ…å†µ
- âœ… **Chrome 6+**: å®Œå…¨æ”¯æŒ
- âœ… **Firefox 6+**: å®Œå…¨æ”¯æŒ  
- âœ… **Safari 5+**: å®Œå…¨æ”¯æŒ
- âœ… **Edge 79+**: å®Œå…¨æ”¯æŒ
- âŒ **IE**: ä¸æ”¯æŒ (è‡ªåŠ¨é™çº§åˆ°ä¼ ç»Ÿæ¨¡å¼)

### é™çº§å¤„ç†
```javascript
if (typeof EventSource === 'undefined') {
    // ä½¿ç”¨ä¼ ç»Ÿ POST æ–¹å¼
    console.log('SSE ä¸æ”¯æŒï¼Œä½¿ç”¨ä¼ ç»Ÿæ¨¡å¼');
    response = await sendMessage(message, actorId, chatHistory);
} else {
    // ä½¿ç”¨ SSE æµå¼ä¼ è¾“
    response = await sendMessageStream(message, actorId, chatHistory);
}
```

## é”™è¯¯å¤„ç†

### å¸¸è§é”™è¯¯
1. **è¿æ¥è¶…æ—¶**: 30ç§’è¶…æ—¶è‡ªåŠ¨å…³é—­
2. **ç½‘ç»œä¸­æ–­**: æ˜¾ç¤ºé‡è¿æç¤º
3. **æœåŠ¡å™¨é”™è¯¯**: æ˜¾ç¤ºå…·ä½“é”™è¯¯ä¿¡æ¯
4. **æ ¼å¼é”™è¯¯**: JSON è§£æå¤±è´¥å¤„ç†

### é”™è¯¯æ¢å¤
```javascript
eventSource.onerror = function(error) {
    console.error('SSE è¿æ¥é”™è¯¯:', error);
    
    // æ˜¾ç¤ºé”™è¯¯æç¤º
    showStreamingError(messageElement, 'è¿æ¥ä¸­æ–­ï¼Œè¯·é‡è¯•');
    
    // æ¸…ç†è¿æ¥
    eventSource.close();
    
    // å¯é€‰ï¼šè‡ªåŠ¨é‡è¯•
    setTimeout(() => {
        retryConnection();
    }, 3000);
};
```

## å¼€å‘è°ƒè¯•

### æµ‹è¯• SSE è¿æ¥
```bash
# ç›´æ¥æµ‹è¯• SSE ç«¯ç‚¹
curl -N -H "Accept: text/event-stream" \
  "http://localhost:3001/api/chat/stream?message=hello&actorId=wise-sage"
```

### æµè§ˆå™¨è°ƒè¯•
1. æ‰“å¼€å¼€å‘è€…å·¥å…·
2. æŸ¥çœ‹ Network æ ‡ç­¾
3. æ‰¾åˆ° `chat/stream` è¯·æ±‚
4. è§‚å¯Ÿ EventStream æ•°æ®

### æ§åˆ¶å°æµ‹è¯•
```javascript
// åœ¨æµè§ˆå™¨æ§åˆ¶å°ä¸­æµ‹è¯•
window.actorAPI.streamingDemo();
```

## æ€§èƒ½æŒ‡æ ‡

### ç”¨æˆ·æ„ŸçŸ¥æ€§èƒ½
- **é¦–å­—èŠ‚æ—¶é—´**: < 200ms
- **å®Œæ•´å›å¤æ—¶é—´**: æ ¹æ®å†…å®¹é•¿åº¦è€Œå®š
- **æ‰“å­—é€Ÿåº¦**: å¯é…ç½® (10-50 å­—ç¬¦/ç§’)

### æŠ€æœ¯æ€§èƒ½
- **å†…å­˜ä½¿ç”¨**: æµå¼ä¼ è¾“æ¯”ä¼ ç»Ÿæ–¹å¼èŠ‚çœ 30-50% å†…å­˜
- **ç½‘ç»œæ•ˆç‡**: å®æ—¶ä¼ è¾“ï¼Œå‡å°‘ç­‰å¾…æ—¶é—´
- **CPU ä½¿ç”¨**: å¢é‡æ¸²æŸ“ï¼Œé™ä½ CPU è´Ÿè½½

## æœ€ä½³å®è·µ

### 1. ç”¨æˆ·ä½“éªŒ
- æä¾›æ¸…æ™°çš„æµå¼çŠ¶æ€æŒ‡ç¤º
- å…è®¸ç”¨æˆ·é€‰æ‹©æ˜¯å¦å¯ç”¨
- åœ¨ç½‘ç»œä¸ä½³æ—¶è‡ªåŠ¨é™çº§

### 2. æ€§èƒ½ä¼˜åŒ–
- åˆç†è®¾ç½®ç¼“å†²åŒºå¤§å°
- é¿å…è¿‡äºé¢‘ç¹çš„ DOM æ›´æ–°
- åŠæ—¶æ¸…ç†ä¸éœ€è¦çš„è¿æ¥

### 3. é”™è¯¯å¤„ç†
- æä¾›å‹å¥½çš„é”™è¯¯æç¤º
- å®ç°è‡ªåŠ¨é‡è¯•æœºåˆ¶
- ä¿ç•™é™çº§æ–¹æ¡ˆ

### 4. å®‰å…¨è€ƒè™‘
- éªŒè¯ SSE è¯·æ±‚æ¥æº
- å®æ–½é€‚å½“çš„é€Ÿç‡é™åˆ¶
- é˜²æ­¢æ¶æ„é•¿è¿æ¥

## æœªæ¥æ‰©å±•

### è®¡åˆ’åŠŸèƒ½
- **å¤šè¯­è¨€æµå¼æ”¯æŒ**: æ”¯æŒä¸åŒè¯­è¨€çš„æ‰“å­—é€Ÿåº¦
- **è¯­éŸ³åˆæˆé›†æˆ**: è¾¹ç”Ÿæˆè¾¹è¯­éŸ³æ’­æŠ¥
- **è‡ªå®šä¹‰æ‰“å­—æ•ˆæœ**: ç”¨æˆ·å¯è°ƒèŠ‚æ‰“å­—é€Ÿåº¦å’Œæ•ˆæœ
- **åä½œèŠå¤©**: å¤šç”¨æˆ·å®æ—¶èŠå¤©æ”¯æŒ

### æŠ€æœ¯æ”¹è¿›
- **WebSocket æ”¯æŒ**: æ›´ä½å»¶è¿Ÿçš„åŒå‘é€šä¿¡
- **æ–­ç‚¹ç»­ä¼ **: ç½‘ç»œä¸­æ–­åæ¢å¤ç”Ÿæˆ
- **å‹ç¼©ä¼ è¾“**: å‡å°‘å¸¦å®½ä½¿ç”¨
- **æ™ºèƒ½ç¼“å­˜**: åŸºäºç”¨æˆ·è¡Œä¸ºçš„ç¼“å­˜ç­–ç•¥

é€šè¿‡ SSE æµå¼ä¼ è¾“ï¼ŒAI è§’è‰²èŠå¤©ç³»ç»Ÿæä¾›äº†æ›´åŠ è‡ªç„¶ã€æµç•…çš„ç”¨æˆ·ä½“éªŒï¼Œè®©äººæœºå¯¹è¯å˜å¾—æ›´åŠ ç”ŸåŠ¨æœ‰è¶£ã€‚
